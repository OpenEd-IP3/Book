
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Module 3: Locating KITT Using Audio Communication &#8212; Autonomous Driving Challenge</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Module 3';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Audio Channel measurements" href="Audio%20Channel.html" />
    <link rel="prev" title="Module 2 - Reading KITT sensor data" href="Module2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/truck.jpg" class="logo__image only-light" alt="Autonomous Driving Challenge - Home"/>
    <script>document.write(`<img src="_static/truck.jpg" class="logo__image only-dark" alt="Autonomous Driving Challenge - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction to IP3: Autonomous Driving Challenge
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Setup and Preliminary Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basics.html">Basics and Course Overview</a></li>

<li class="toctree-l1"><a class="reference internal" href="Module1.html">Module 1 - Connecting with and Controlling KITT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Module2.html">Module 2 - Reading KITT sensor data</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Module 3: Locating KITT Using Audio Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="Audio%20Channel.html">Audio Channel measurements</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/OpenEd-IP3/Book/main?urlpath=tree/Module 3.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/OpenEd-IP3/Book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OpenEd-IP3/Book/issues/new?title=Issue%20on%20page%20%2FModule 3.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Module 3.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Module 3: Locating KITT Using Audio Communication</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-recorded-data">Pre-recorded data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-knowledge">Background Knowledge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution-in-frequency-domain">Deconvolution in Frequency Domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-deconvolution-in-frequency-domain">Problems with deconvolution in frequency-domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tasks">Tasks</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="module-3-locating-kitt-using-audio-communication">
<h1>Module 3: Locating KITT Using Audio Communication<a class="headerlink" href="#module-3-locating-kitt-using-audio-communication" title="Link to this heading">#</a></h1>
<p>KITT must be located in its field and then directions must be determined to navigate to the final destination. In the previous modules your colleagues are developing scripts to communicate with KITT. They will add functionality to read the audio signals from the microphones located around the field, and you should use these to locate the car. It is recommended to read Modules 1 and 2 to have a better understanding of how everything should work together.</p>
<p>For the localization, we will use (real-time) recordings of the beacon signal at the various microphones, deconvolve these using a reference signal recording, and determine the relative time delays from the resulting channel estimates. Depending on the distance to each microphone, the signal transmitted by KITT’s beacon arrives a little bit earlier or later, and you can convert that into physical distances. For each pair of microphones, we can compute this time difference of arrival (TDOA), or the physical difference in propagation distance. If you have measurements from enough microphones, then you can calculate the location of KITT in the field.</p>
<p>7 recodings with known locations and a reference recording taken close to the microphone will be provided in this task. This can be used to develop and test your algorithms.</p>
<p>At the end of this Module, you will have developed a script to locate KITT within the field with reason- able accuracy, and you will do so using the data recorded by the microphones located along the field. You will also have tested and verified the accuracy and robustness of your solution.</p>
<section id="pre-recorded-data">
<h2>Pre-recorded data<a class="headerlink" href="#pre-recorded-data" title="Link to this heading">#</a></h2>
<p>These recordings have locations randomly distributed across the field. An example recording with the location are,</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>x</p></th>
<th class="head"><p>y</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>64</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>82</p></td>
<td><p>399</p></td>
</tr>
<tr class="row-even"><td><p>109</p></td>
<td><p>76</p></td>
</tr>
<tr class="row-odd"><td><p>143</p></td>
<td><p>296</p></td>
</tr>
<tr class="row-even"><td><p>150</p></td>
<td><p>185</p></td>
</tr>
<tr class="row-odd"><td><p>178</p></td>
<td><p>439</p></td>
</tr>
<tr class="row-even"><td><p>232</p></td>
<td><p>275</p></td>
</tr>
</tbody>
</table>
<p><em>Table 1: Sample Data Table</em></p>
<p>The x and y axe are defined as follows, where the numbers refer to the microphone index:</p>
<figure class="align-default" id="mic-figure">
<img alt="_images/axisdef.png" src="_images/axisdef.png" />
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Microphone Axis definition</span><a class="headerlink" href="#mic-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>You can assume these positions for the microphones. Please note the different height of microphone 5.</p>
</section>
<section id="background-knowledge">
<h2>Background Knowledge<a class="headerlink" href="#background-knowledge" title="Link to this heading">#</a></h2>
<p>We will study channel estimation: how do we measure the impulse response from a microphone to a loudspeaker? The specific topics you’ll learn in this labday are channel estimation in time-domain (matched filter) and frequency domain. In Labday 4, we will test all this on audio signals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>           <span class="c1"># For plotting purposes</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>                        <span class="c1"># For convolution function</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>                  <span class="c1"># For filter function</span>
<span class="kn">from</span> <span class="nn">scipy.fft</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span>           <span class="c1"># For fft and ifft</span>
<span class="kn">import</span> <span class="nn">math</span>                               <span class="c1"># For numerical approximation of pi</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Suppose we transmit a known signal <span class="math notranslate nohighlight">\(x[n]\)</span> over a communication
channel, and measure the result <span class="math notranslate nohighlight">\(y[n]\)</span>.  The channel acts as a
filter, which we will assume to be linear and time-invariant.
Therefore, the measured signal is a convolution of the transmitted
signal by the channel impulse response <span class="math notranslate nohighlight">\(h[n]\)</span>, such that
<span class="math notranslate nohighlight">\(y[n] = h[n] \ast x[n]\)</span>.  Knowing the transmitted signal <span class="math notranslate nohighlight">\(x[n]\)</span>, can
we recover the impulse response of the communication channel from
<span class="math notranslate nohighlight">\(y[n]\)</span>?  This is essentially an inversion problem.</p>
<p>Indeed, if we do this in the frequency domain, we have
<span class="math notranslate nohighlight">\(
H(\omega) = \frac{Y(\omega)}{X(\omega)}
\,,
\)</span></p>
<p>and we can recover ( h[n] ) from an inverse DTFT. However, there are some complications to do this in the frequency domain. Can we use the DFT instead of the DTFT (which leads to sampling in the frequency domain)?</p>
<p>Are there numerical problems with the above division, what if <span class="math notranslate nohighlight">\(X(\omega) = 0\)</span>?</p>
<p>Will ( h[n] ) be causal? What about stability?</p>
<p>Alternatively, we can do the deconvolution in the time domain.  This leads to a matrix inversion problem. Also
here, there can be numerical problems.  If the matrix is poorly invertible, then additive noise will be enhanced, and
the resulting channel impulse response estimate will be poor.</p>
<p>We will need channel estimation in the EPO4 project, where each toy
car will transmit audio beacon signals, which are recorded by
microphones at the corners of the field.  From differences in the
estimated channels, we will locate the car.  We also want to be
insensitive to interfering signals: if several beacons are
transmitting audio signals at the same time, we only want to detect
our own transmitting sequence.</p>
<p>Estimation of a propagation channel as studied here is fundamental in many applications. In radar it allows to estimate the distance of objects, in geophysics it represents the reflections at earth layers, in medical ultrasound it allows to form an image of a patient.</p>
<p>To estimate <span class="math notranslate nohighlight">\(h[n]\)</span>, three alternative algorithms were described:</p>
<ul class="simple">
<li><p>Deconvolution in the time domain: Involves matrix inversion. It is computationally complex and
requires lots of memory (easily more than what the available PCs can handle).</p></li>
<li><p>The matched filter: Avoids the matrix inversion. It is equal to computing the cross-correlation of
<span class="math notranslate nohighlight">\(y[n]\)</span> with <span class="math notranslate nohighlight">\(x[n]\)</span>. As cross-correlation is equivalent to a convolution with a reverse signal <span class="math notranslate nohighlight">\(x[−n]\)</span>, it can be computed efficiently using the FFT. The resulting channel estimate is equal to the true
channel convolved with the autocorrelation of the pulse, <span class="math notranslate nohighlight">\(x[n] ∗ x[−n]\)</span>. Therefore, its performance
heavily depends on having the correct (i.e., accurate) “reference” or “training” signal to correlate
your measurements with, and the signal should have good autocorrelation properties: <span class="math notranslate nohighlight">\(x[n] ∗ x[−n]\)</span>
should be close to a delta spike. Large sidelobes will lead to confusion.</p></li>
<li><p>Deconvolution in the frequency domain: Involves the FFT. It computes the same channel as via
deconvolution in the time domain but is much more efficient: convolution in time becomes point-
wise multiplication in frequency, hence for deconvolution in the frequency domain, we only need
a pointwise division, followed by an IFFT to obtain the time-domain channel impulse response.</p></li>
</ul>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>FFT and IFFT lead to periodicities (the result is cyclic, and samples <span class="math notranslate nohighlight">\(x[n]\)</span> at negative time reappear
at the “large n” part of the signal). Since this method is similar to ch1 (but much more efficient),
you can view this method as a matched filter, followed by a correction step that “inverts” the effect
of the autocorrelation of the transmit pulse. However, since we should not divide by zero, you will
also need to implement a “threshold” to set non-invertible or very small frequency coefficients of
<span class="math notranslate nohighlight">\(x[n]\)</span> to zero, which otherwise will lead to noise amplification. The performance depends on this
threshold, which has to be chosen heuristically.</p>
</div>
<p>In each case, a reference signal <span class="math notranslate nohighlight">\(x[n]\)</span> is required. We recommend using a recording close to the beacon be-
cause then <span class="math notranslate nohighlight">\(x[n]\)</span> includes the loudspeaker and microphone responses as well. For the pre-made recordings,
a high-quality reference is available.
The deconvolution algorithm gives a channel estimate for the beacon path to each microphone. After this,
we detect the first incoming path, which, assuming Line of Sight (LOS), corresponds to the propagation
delay of the car beacon to each microphone. Unfortunately, we do not know the transmit time, so we only
obtain relative propagation delays. If we take the difference of microphone delays, this unknown transmit
time is eliminated, so we can obtain time difference of arrival (TDOA) samples for each microphone pair.
In the next sections, we will use these to locate the car.</p>
</section>
<section id="deconvolution-in-frequency-domain">
<h2>Deconvolution in Frequency Domain<a class="headerlink" href="#deconvolution-in-frequency-domain" title="Link to this heading">#</a></h2>
<p>Deconvolution in time domain may become complicated if the channel length ( L ) is large.
In that case, <span class="math notranslate nohighlight">\( \mathbf{X} \)</span> becomes too large to invert. At the same time, the Matched Filter may be imprecise and hard to interpret if the autocorrelation sequence ( r[n] ) has large sidelobes. An alternative to the Matched Filter is to do the deconvolution in the frequency domain.</p>
<p>Recall that a convolution in the time domain corresponds to a multiplication in the frequency domain. From <span class="math notranslate nohighlight">\( y[n] = h[n] \ast x[n] \)</span> we can derive <span class="math notranslate nohighlight">\( Y(\omega) = H(\omega) X(\omega) \)</span> and hence we can estimate <span class="math notranslate nohighlight">\( H(\omega) = \frac{Y(\omega)}{X(\omega)} \)</span>.
However, this property is valid for the DTFT, whereas in practice we have to use the DFT (or in fact the FFT): we evaluate <span class="math notranslate nohighlight">\(\omega \)</span> for only a fixed set of frequencies <span class="math notranslate nohighlight">\( \frac{2\pi}{N} k \)</span>, with <span class="math notranslate nohighlight">\( 0 \le k \le N-1 \)</span>.</p>
<p>Since we sample in the frequency domain, we can expect some complications: periodicity and aliasing in the time domain! As we will see there, the complications are minimal if we assume the following:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( N_y &gt; N_x + L - 1 \)</span>, i.e., the training sequence has finite length and the observation is long enough</p></li>
<li><p>The sequences ( x[n] ), ( h[n] ), and ( y[n] ) are zero padded to a common length <span class="math notranslate nohighlight">\( N \ge N_y \)</span>.</p></li>
</ul>
<p>In this case, let ( X[k] ) be the DFT of ( x[n] ), and similarly for ( H[k] ) and ( Y[k] ), then</p>
<p><span class="math notranslate nohighlight">\(
Y[k] = H[k] X[k] \qquad,  \mbox{for } 0 \le k \le N-1
\)</span></p>
<p>Given <span class="math notranslate nohighlight">\(X[k]\)</span> and <span class="math notranslate nohighlight">\(Y[k]\)</span>, we can compute</p>
<p><span class="math notranslate nohighlight">\(
H[k] = \frac{Y[k]}{X[k]}\,,
\qquad
0 \le k \le N-1
\)</span></p>
<p>and obtain an estimate of the channel in DFT domain.
Next, the inverse Fourier transform is applied to the sequence
<span class="math notranslate nohighlight">\(H[k]\)</span> to obtain the channel impulse reponse <span class="math notranslate nohighlight">\(\mathbf{h}\)</span>.  Together these
steps implement a deconvolution in frequency domain that should be equal to the channel estimate obtained using the matrix inversion technique.  A major advantage is its computational simplicity: we need 3 FFTs (complexity order <span class="math notranslate nohighlight">\(3 N \log N\)</span>) and a pointwise division (complexity order <span class="math notranslate nohighlight">\(N\)</span>), rather than a matrix
inversion of the Toeplitz matrix <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> (complexity order <span class="math notranslate nohighlight">\(N_y\, L^2\)</span>).  We also do not need to store large matrices.</p>
<p>This method can be done as follows,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#example</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">])</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>

<span class="n">Ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>      <span class="c1"># Length of y</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>      <span class="c1"># Length of x</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">Ny</span> <span class="o">-</span> <span class="n">Nx</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1">#length of channel (reliable?)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>     <span class="c1"># Make x same length as y</span>

<span class="c1"># deconvolution in frequency domain</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>             
<span class="n">X</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">Y</span><span class="o">/</span><span class="n">X</span>                 <span class="c1"># pointwise division (divide by zero problems?)</span>

<span class="c1"># Back transformation</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ifft</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>    <span class="c1"># ensure the result is real-valued</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">L</span><span class="p">]</span>              <span class="c1"># optional: truncate to a smaller length L (reliable?)</span>
</pre></div>
</div>
</div>
</div>
<p>Also the Matched Filter could be computed in frequency domain. In time
domain, the Matched Filter computes <span class="math notranslate nohighlight">\(\hat{h}[n] = y[n] \ast
x[-n]\)</span>.  If as before <span class="math notranslate nohighlight">\(N_y &gt; N_x + L-1\)</span> and we take care using zero padding that
sequences have equal length <span class="math notranslate nohighlight">\(N\)</span>, then the equivalent of the Matched Filter in
frequency domain is
<span class="math notranslate nohighlight">\(
\hat{H}[k] = Y[k] X^*[k]
\)</span>
Also the Matched Filter could be computed in frequency domain. In time
domain, the Matched Filter computes <span class="math notranslate nohighlight">\(\hat{h}[n] = y[n] \ast
x[-n]\)</span>.  If as before <span class="math notranslate nohighlight">\(N_y &gt; N_x + L-1\)</span> and we take care using zero padding that
sequences have equal length <span class="math notranslate nohighlight">\(N\)</span>, then the equivalent of the Matched Filter in
frequency domain is
<span class="math notranslate nohighlight">\(
\hat{H}[k] = Y[k] X^*[k]
\)</span></p>
</section>
<section id="problems-with-deconvolution-in-frequency-domain">
<h2>Problems with deconvolution in frequency-domain<a class="headerlink" href="#problems-with-deconvolution-in-frequency-domain" title="Link to this heading">#</a></h2>
<p>Since a pointwise division is done in frequency domain, it is
immediately clear that the performance will be low for frequencies
where <span class="math notranslate nohighlight">\(X[k]\)</span> is small.  Thus, this will only work for training
sequences that resemble either an impulse or “white noise” random
sequences, as these have a wide frequency content. A sinusoid is
the worst training sequence, since its frequency content is almost
zero everywhere. You can’t estimate the channel at frequencies where the input signal is zero!</p>
<p>In practice, we should invert <span class="math notranslate nohighlight">\(X[k]\)</span> only for frequencies where it
is sufficiently strong, and set the estimates of the remaining
<span class="math notranslate nohighlight">\(H[k]\)</span> equal to zero.
Suppose we use a threshold <span class="math notranslate nohighlight">\(\epsilon\)</span> and set <span class="math notranslate nohighlight">\(\hat{H}[k] =
0\)</span> if <span class="math notranslate nohighlight">\(|X[k]| &lt; \epsilon\)</span>. Then the channel estimate <span class="math notranslate nohighlight">\(\hat{H}[k]\)</span>
which we obtain satisfies</p>
<p><span class="math notranslate nohighlight">\(
\hat{H}[k] = H[k] G[k]\,,\qquad \mbox{where }
G[k] = \left\{\begin{array}{ll}
1, &amp; |X[k]| &gt; \epsilon \\
0, &amp; \mbox{elsewhere} \end{array}\right. \quad \quad (6)
\)</span></p>
<p>In time domain, the estimate <span class="math notranslate nohighlight">\(\hat{h}[n] = h[n] \ast g[n]\)</span> is the
convolution of the true channel with this “selector function”. This
will limit the resolution that can be obtained.</p>
<p>Another problem with frequency-domain equalization is that
there is no guarantee that the computed <span class="math notranslate nohighlight">\(\mathbf{h}\)</span> corresponds to an FIR
channel - in general, this will be a vector that has all <span class="math notranslate nohighlight">\(N\)</span>
entries nonzero.</p>
<p>Moreover, due to frequency-domain sampling, the channel estimate is one period of a periodic sequence. Therefore, in some cases you may observe that the tail (high-<span class="math notranslate nohighlight">\(n\)</span>) values of <span class="math notranslate nohighlight">\(\hat{h}[n]\)</span> are in fact values for small negative <span class="math notranslate nohighlight">\(n\)</span>. This will in particular be visible if you do delay estimation and the delay is negative.</p>
</section>
<section id="tasks">
<h2>Tasks<a class="headerlink" href="#tasks" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Implement frequency-domain
equalization as a function <code class="docutils literal notranslate"><span class="pre">ch3</span></code>.  As input parameter, include a threshold
<span class="math notranslate nohighlight">\(\epsilon\)</span> on the inversion of <span class="math notranslate nohighlight">\(X[k]\)</span>. As refinement of the previous discussion, we want <span class="math notranslate nohighlight">\(\epsilon\)</span> to be a threshold relative to the peak amplitude in frequency domain: <span class="math notranslate nohighlight">\(\epsilon \max_k |X[k]|\)</span>. Such a relative threshold makes your function insensitive to a scaling of <span class="math notranslate nohighlight">\(X[k]\)</span>, which could easily occur if you modify <span class="math notranslate nohighlight">\(N\)</span>.</p></li>
<li><p>Test the function using the three test signals.</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The indices of
the entries of a vector smaller than the relative threshold are found like this:
<code class="docutils literal notranslate"><span class="pre">ii</span> <span class="pre">=</span> <span class="pre">np.absolute(X)</span> <span class="pre">&lt;</span> <span class="pre">epsi*max(np.absolute(X))</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ch3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Lhat</span><span class="p">,</span><span class="n">epsi</span><span class="p">):</span>
    <span class="c1"># your code here            # Length of x</span>
    <span class="c1"># your code here              # Length of y</span>
    <span class="c1"># your code here            # Length of h</span>

    <span class="c1"># Force x to be the same length as y</span>
   <span class="c1"># your code here</span>

    <span class="c1"># Deconvolution in frequency domain</span>
    <span class="c1"># your code here</span>

    <span class="c1"># Threshold to avoid blow ups of noise during inversion</span>
    <span class="c1"># your code here</span>

    <span class="c1">#h = # your code here    # ensure the result is real</span>
    <span class="c1">#h = # your code here    # optional: truncate to length Lhat (L is not reliable?)</span>
    <span class="k">return</span> <span class="n">h</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># test your ch3 function here:</span>
<span class="c1"># Channel</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">Lhat</span> <span class="o">=</span> <span class="mi">5</span>      <span class="c1"># estimate of channel length L, but could be different</span>

<span class="c1"># Input length</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># Input: x1, x2, x3</span>
<span class="c1"># your code here</span>

<span class="c1">## output: y1, y2, y3</span>
<span class="c1"># your code here</span>


<span class="c1"># Channel estimation via deconvolution: h1, h2, h3</span>
<span class="c1"># suitable epsi: try values between 0.001 and 0.05</span>
<span class="c1"># your code here</span>

<span class="c1"># Print result, should give true channel (which is [1,2,3,2,1])</span>
<span class="c1">#print(h1)</span>
<span class="c1">#print(h2)</span>
<span class="c1">#print(h3)</span>
</pre></div>
</div>
</div>
</div>
<p>Suppose we have a training sequence <span class="math notranslate nohighlight">\(x[n]\)</span> whose frequency
domain <span class="math notranslate nohighlight">\(X[k]\)</span> is bandlimited, e.g., only contains frequencies smaller
than <span class="math notranslate nohighlight">\(F_c = 1\)</span> kHz whereas the sample frequency is <span class="math notranslate nohighlight">\(F_s = 20\)</span> kHz.</p>
<figure class="align-default" id="xf-figure">
<img alt="_images/XFplot.png" src="_images/XFplot.png" />
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">Frequency domain plot</span><a class="headerlink" href="#xf-figure" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The effect of the threshold technique on <span class="math notranslate nohighlight">\(\hat{h}[n]\)</span> is given by
<span class="math notranslate nohighlight">\((6)\)</span>.  What is <span class="math notranslate nohighlight">\(G[k]\)</span> in this case?  And <span class="math notranslate nohighlight">\(g[n]\)</span>?
Make plots.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Fs</span> <span class="o">=</span> <span class="mi">20</span>     <span class="c1"># unit: kHz</span>
<span class="n">Nsamples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1">#F = #your code here # freq axis 0..10 kHz</span>

<span class="c1">#G = #your code here    # Let G = 1 only for 0..1 kHz</span>
<span class="c1">#g = #your code here</span>

<span class="sd">&#39;&#39;&#39; frequency domain</span>
<span class="sd">plt.figure(figsize=(10,4))</span>
<span class="sd">plt.subplot(121)</span>
<span class="sd">plt.plot(#your code here)</span>
<span class="sd">plt.xlabel(&#39;F [kHz]&#39;)</span>
<span class="sd">plt.ylabel(&#39;Amplitude&#39;) &#39;&#39;&#39;</span>

<span class="c1"># time domain, plot the normalized amplitude (max=1)</span>
<span class="sd">&#39;&#39;&#39;t = #your code here</span>
<span class="sd">plt.subplot(122)</span>
<span class="sd">plt.plot(#your code here);</span>
<span class="sd">plt.xlabel(&#39;t [ms]&#39;)</span>
<span class="sd">plt.ylabel(&#39;Amplitude [normalized]&#39;)&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;t = #your code here\nplt.subplot(122)\nplt.plot(#your code here);\nplt.xlabel(&#39;t [ms]&#39;)\nplt.ylabel(&#39;Amplitude [normalized]&#39;)&quot;
</pre></div>
</div>
</div>
</div>
<p><strong>Summary</strong></p>
<p>Channel estimation in frequency domain is generally efficient and accurate.
A threshold is needed to avoid inverting small values in the spectrum of the input signal: we cannot estimate the channel at frequencies which are not in the input signal. The “missing frequencies” determine the accuracy.</p>
<p>In practice, we have training sequences that are bandlimited, and we can estimate channels only in a frequency band. It should not matter too much which band is selected (i.e. the carrier frequency is not important), although the carrier frequency will show up in the channel estimate as a modulation. The bandwidth of the input signal determines the resolution of the channel estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
<span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "OpenEd-IP3/Book",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Module2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Module 2 - Reading KITT sensor data</p>
      </div>
    </a>
    <a class="right-next"
       href="Audio%20Channel.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Audio Channel measurements</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-recorded-data">Pre-recorded data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-knowledge">Background Knowledge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution-in-frequency-domain">Deconvolution in Frequency Domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-deconvolution-in-frequency-domain">Problems with deconvolution in frequency-domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tasks">Tasks</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By TA
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>